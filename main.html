<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Typing Tutor</title>
  </head>
  <body>
    <style>
      body {
        font-size: 18px;
        font-family: sans-serif;
      }
      .typed { color: green; }
      .untyped { color: black; }
      .current {
        color: white;
        background-color: green;
      }
      .wrong {
        color: white;
        background-color: red;
      }
      .break {
        content: "";
        display: block;
        clear: both;
      }
      .not-visible { visibility: hidden; }
      .visible { visibility: visible; }
      div {
        float: left;
        white-space: pre-wrap;
      }
    </style>
    <form action="">
      <textarea name="textarea" id="textbox" rows="15" cols="100">Enter the text you want to practice typing!</textarea><br/>
      <input type="button" id="submitButton" value="Start practicing"/>
    </form>
    <br />
    <div id="textwrapper"></div>
    <br /><br />
    <input type="button" class="not-visible" id="untypeable" value="Untypeable character?"/>
    <script>

      const butt = document.getElementById("submitButton");
      const badLetter = document.getElementById("untypeable");
      const parentDiv = document.getElementById("textwrapper");
      let allText;
      let currentLetterIdx;

      butt.addEventListener('mousedown', function(e) {
        if (e.preventDefault) { e.preventDefault(); }
        while (parentDiv.firstChild) {
          parentDiv.removeChild(parentDiv.firstChild);
        }
        currentLetterIdx = 0;
        allText = replacements(document.getElementById("textbox").value.split(""));
        debugger
        for (let idx = 0; idx < allText.length; idx++) {
          if (allText[idx].match(/\n/g)) {
            let newDiv = document.createElement("div");
            newDiv.setAttribute("id", idx);
            newDiv.className = "break";
            newDiv.innerHTML = allText[idx];
            parentDiv.appendChild(newDiv);
          } else {
            let newDiv = document.createElement("div");
            newDiv.setAttribute("id", idx);
            newDiv.className = "untyped";
            newDiv.innerHTML = allText[idx];
            parentDiv.appendChild(newDiv);
          }
        }
        document.getElementById(currentLetterIdx).className = "current";
        document.getElementById("untypeable").className = "visible";
        document.getElementById("textbox").value = "Enter the text you want to practice typing!";
      });

      badLetter.addEventListener('mousedown', function(e) {
        if (e.preventDefault) { e.preventDefault(); }
        let prevLetter = document.getElementById(currentLetterIdx);
        prevLetter.className = "typed";
        currentLetterIdx++;
        let newLetter = document.getElementById(currentLetterIdx);
        newLetter.className = "current";
      });

      function replacements(text) {
        let replace = {
          "’": "'",
          "—": "-",
          "“": "\"",
          "”": "\""
        };
        for (let idx = 0; idx < text.length; idx++) {
          let sym = text[idx];
          if (sym in replace) {
            text[idx] = replace[sym];
          }
        }
        return text;
      }

      function keyPressHandler(e) {
        if (e.preventDefault) { e.preventDefault(); }
        if (e.key === allText[currentLetterIdx]) {
          let prevLetter = document.getElementById(currentLetterIdx);
          prevLetter.className = "typed";
          currentLetterIdx++;
          let newLetter = document.getElementById(currentLetterIdx);
          newLetter.className = "current";
        } else {
          let prevLetter = document.getElementById(currentLetterIdx);
          prevLetter.className = "wrong";
          currentLetterIdx++;
          let newLetter = document.getElementById(currentLetterIdx);
          newLetter.className = "current";
        }
      }

      function keyDownHandler(e) {
        if (e.key === "Backspace" && currentLetterIdx > 0) {
          let prevLetterIdx = currentLetterIdx - 1;
          let prevLetter = document.getElementById(prevLetterIdx);
          let currentLetter = document.getElementById(currentLetterIdx);
          currentLetter.className = "untyped";
          prevLetter.className = "current";
          currentLetterIdx = prevLetterIdx;
        }
      }

      document.addEventListener("keypress", keyPressHandler, false);
      document.addEventListener("keydown", keyDownHandler, false);
    </script>
  </body>
</html>
